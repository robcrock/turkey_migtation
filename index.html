<html>

<head>
  <meta charset='utf-8' />
  <title>Turkey Migration</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src="//d3js.org/topojson.v1.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <!-- <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.43.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.43.0/mapbox-gl.css' rel='stylesheet' /> -->
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>

<body>

  <svg width="960" height="500"></svg>
  <script>

    const svg = d3.select('svg');
    const path = svg.append('path');
    const projection = d3.geoOrthographic();
    const initialScale = projection.scale();
    const geoPath = d3.geoPath().projection(projection);
    const sensitivity = 58;
    const gistURL = 'https://gist.githubusercontent.com/robcrock/a30f589308f73f234f46986a21676e30/raw/d1a632ced68f1cf115a5ca9af8baafa6920da05d/data_slim.csv';

    d3.csv(gistURL, (error, data) => {

      const featureCollection = {
        "type": "FeatureCollection",
        "features": [ /* append featuresObj */]
      };
      const featuresObj = {
        "type": "Feature",
        "geometry": { /* append geometryObj */ },
        "properties": { /* append propertiesObj */ }
      };
      const geometryObj = {
        "type": "LineString",
        "coordinates": [ /* longitutde */, /* latitude */]
      };
      const propertiesObj = {
        "study_timezone": ""
      };

      const sortedData = data.sort(function (a, b) {
        return d3.descending(parseInt(a.event_id), parseInt(b.event_id));
      })

      const singleEvent = sortedData.filter(function (d) {
        return d.animal_id === 'Steamhouse 2';
      })

      var nestedData = d3.nest()
        .key(function (d) { return d.animal_id; })
        .entries(singleEvent);


      nestedData.forEach(function (turkey) {

        let turkeyObj = {
          "type": "Feature",
          "geometry": { /* append geometryObj */ },
          "properties": { /* append propertiesObj */ }
        };
        let movementObj = {
          "type": "LineString",
          "coordinates": []
        };
        let turkeyProperties = {
          "study_timezone": ""
        };

        turkey.values.forEach(function (movement) {

          movementObj.coordinates.push([movement.longitude, movement.latitude])

        })

        turkeyObj.geometry = movementObj;

        turkeyProperties.study_timezone = turkey.values[0].study_timezone;

        turkeyObj.properties = turkeyProperties;

        featureCollection.features.push(turkeyObj)

      console.log(geoPath(featureCollection));

      // const land = topojson.feature(data, world.objects.land);
      const render = () => path
        .attr('d', geoPath(featureCollection))
        .attr('fill', 'none')
        .style('stroke', '#FF00FF');
      render();

      svg
        .call(d3.drag().on('drag', () => {
          const rotate = projection.rotate();
          const k = sensitivity / projection.scale();
          projection.rotate([
            rotate[0] + d3.event.dx * k,
            rotate[1] - d3.event.dy * k
          ])
          render();
        }))
        .call(d3.zoom().on('zoom', () => {
          projection.scale(initialScale * d3.event.transform.k);
          render();
        }));
    });
  });

    // const gistURL = 'https://gist.githubusercontent.com/robcrock/a30f589308f73f234f46986a21676e30/raw/d1a632ced68f1cf115a5ca9af8baafa6920da05d/data_slim.csv';

    // d3.csv(gistURL, (error, data) => {

    //   const featureCollection = {
    //     "type": "FeatureCollection",
    //     "features": [ /* append featuresObj */]
    //   };
    //   const featuresObj = {
    //     "type": "Feature",
    //     "geometry": { /* append geometryObj */ },
    //     "properties": { /* append propertiesObj */ }
    //   };
    //   const geometryObj = {
    //     "type": "LineString",
    //     "coordinates": [ /* longitutde */, /* latitude */]
    //   };
    //   const propertiesObj = {
    //     "study_timezone": ""
    //   };

    //   const sortedData = data.sort(function (a, b) {
    //     return d3.descending(parseInt(a.event_id), parseInt(b.event_id));
    //   })

    //   const singleEvent = sortedData.filter(function (d) {
    //     return d.animal_id === 'Steamhouse 2';
    //   })

    //   var nestedData = d3.nest()
    //     .key(function (d) { return d.animal_id; })
    //     .entries(singleEvent);


    //   nestedData.forEach(function (turkey) {

    //     let turkeyObj = {
    //       "type": "Feature",
    //       "geometry": { /* append geometryObj */ },
    //       "properties": { /* append propertiesObj */ }
    //     };
    //     let movementObj = {
    //       "type": "LineString",
    //       "coordinates": []
    //     };
    //     let turkeyProperties = {
    //       "study_timezone": ""
    //     };

    //     turkey.values.forEach(function (movement) {

    //       movementObj.coordinates.push([movement.longitude, movement.latitude])

    //     })

    //     turkeyObj.geometry = movementObj;

    //     turkeyProperties.study_timezone = turkey.values[0].study_timezone;

    //     turkeyObj.properties = turkeyProperties;

    //     featureCollection.features.push(turkeyObj)

    //     // Define Zoom Function Event Listener
    //     function zoomFunction() {
    //       projection.scale(initialScale * d3.event.transform.k);
    //       render();
    //     }

    //     const svg = d3.select('svg');
    //     const path = svg.append('path');
    //     const projection = d3.geoWiechelRaw;
    //     const initialScale = projection.scale();
    //     const geoPath = d3.geoPath().projection(projection);

    //     svg.call(d3.zoomFunction().on('zoom', zoomFunction))

    //     const lineStringPath = svg
    //       .append('path')
    //         .attr('d', geoPath(featureCollection))
    //         .style('stroke', '#FF00FF');

    //     console.log(lineStringPath);

    // });
  // });

  </script>

</body>

</html>